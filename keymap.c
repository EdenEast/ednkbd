/* A standard layout for the Dactyl Manuform 5x6 Keyboard */

#include QMK_KEYBOARD_H

#include "keymap.h"

const uint16_t PROGMEM keymaps[][MATRIX_ROWS][MATRIX_COLS] = {

/**
 * Base (Colemak-DH) https://colemakmods.github.io/mod-dh/keyboards.html#matrix-keyboards
 * +-----------------------------------------------+                       +-----------------------------------------------+
 * |   `   |   1   |   2   |   3   |   4   |   5   |                       |   6   |   7   |   8   |   9   |   0   |   =   |
 * |-------+-------+-------+-------+-------+-------|                       |-------+-------+-------+-------+-------+-------|
 * |   -   |   q   |   w   |   f   |   p   |   b   |                       |   j   |   l   |   u   |   y   |   ;   |   _   |
 * |-------+-------+-------+-------+-------+-------|                       |-------+-------+-------+-------+-------+-------|
 * |  esc  |   a   |   r   |   s   |   t   |   d   |                       |   m   |   n   |   e   |   i   |   o   |   '   |
 * |-------+-------+-------+-------+-------+-------|                       |-------+-------+-------+-------+-------+-------|
 * |   :   |   z   |   x   |   c   |   d   |   v   |                       |   k   |   h   |   ,   |   .   |   /   |   \   |
 * +---------------+-------+-------+---------------+                       +---------------+-------+-------+---------------+
 *                 |   [   |   ]   |                                                       |   (   |   )   |
 *                 +---------------+---------------+                       +---------------+---------------+
 *                                 |nav_tab|bspace |                       | space |sym_ent|
 *                                 +---------------+                       +---------------+
 *                                         +---------------+       +---------------+
 *                                         | delete|1sh lsf|       |1sh rsf|   up  |
 *                                         |-------+-------|       |-------+-------|
 *                                         |qrty_tg| media |       |sw_hand|  down |
 *                                         +---------------+       +---------------+
 */
[_COLEMAK_DH] = LAYOUT_5x6(
    KC_GRV ,KC_1   ,KC_2   ,KC_3   ,KC_4   ,KC_5   ,                        KC_6   ,KC_7   ,KC_8   ,KC_9   ,KC_0   ,KC_EQL , \
    KC_MINS,KC_Q   ,KC_W   ,KC_F   ,KC_P   ,KC_B   ,                        KC_J   ,KC_L   ,KC_U   ,KC_Y   ,KC_SCLN,KC_UNDS, \
    KC_ESC ,HOME_A ,HOME_R ,HOME_S ,HOME_T ,KC_G   ,                        KC_M   ,HOME_N ,HOME_E ,HOME_I ,HOME_O ,KC_QUOT, \
    KC_COLN,KC_Z   ,KC_X   ,KC_C   ,KC_D   ,KC_V   ,                        KC_K   ,KC_H   ,KC_COMM,KC_DOT ,KC_SLSH,KC_BSLS, \
                    KC_LBRC,KC_RBRC,                                                        KC_LPRN,KC_RPRN,                 \
                                    NAV_TAB,KC_BSPC,                        KC_SPC ,SYM_ENT,                                 \
                                            KC_DEL ,OS_LSFT,        OS_RSFT,KC_UP  ,                                         \
                                            QRTY_TG,SH_OS  ,        MEDIA  ,KC_DOWN                                          \
),

[_QWERTY] = LAYOUT_5x6(
    _______,_______,_______,_______,_______,_______,                        _______,_______,_______,_______,_______,_______, \
    _______,KC_Q   ,KC_W   ,KC_E   ,KC_R   ,KC_T   ,                        KC_Y   ,KC_U   ,KC_I   ,KC_O   ,KC_P   ,_______, \
    _______,HOME_A ,HOME_SS,HOME_D ,HOME_F ,KC_G   ,                        KC_H   ,HOME_J ,HOME_K ,HOME_L ,HOME_SC,_______, \
    _______,KC_Z   ,KC_X   ,KC_C   ,KC_V   ,KC_B   ,                        KC_N   ,KC_M   ,_______,_______,_______,_______, \
                    _______,_______,                                                        _______,_______,                 \
                                    _______,_______,                        _______,_______,                                 \
                                            _______,_______,        _______,_______,                                         \
                                            _______,_______,        _______,_______                                          \
),

/**
 * Symbols
 * +-----------------------------------------------+                       +-----------------------------------------------+
 * |  f12  |  f1   |  f1   |  f3   |  f4   |  f5   |                       |  f6   |  f7   |  f8   |  f9   |  f10  |  f11  |
 * |-------+-------+-------+-------+-------+-------|                       |-------+-------+-------+-------+-------+-------|
 * |       |   1   |   2   |   3   |   4   |   5   |                       |   6   |   7   |   8   |   9   |   0   |       |
 * |-------+-------+-------+-------+-------+-------|                       |-------+-------+-------+-------+-------+-------|
 * |       |   !   |   @   |   #   |   $   |   %   |                       |   ^   |   &   |   *   |   =   |   +   |       |
 * |-------+-------+-------+-------+-------+-------|                       |-------+-------+-------+-------+-------+-------|
 * |       |       |       |       |       |       |                       |       |       |       |       |       |       |
 * +---------------+-------+-------+---------------+                       +---------------+-------+-------+---------------+
 *                 |       |       |                                                       |       |       |
 *                 +---------------+---------------+                       +---------------+---------------+
 *                                 |       |       |                       |       |       |
 *                                 +---------------+                       +---------------+
 *                                         +---------------+       +---------------+
 *                                         |       |       |       |       |       |
 *                                         |-------+-------|       |-------+-------|
 *                                         |       |       |       |       |       |
 *                                         +---------------+       +---------------+
 */
[_SYM] = LAYOUT_5x6(
    KC_F12 ,KC_F1  ,KC_F2  ,KC_F3  ,KC_F4  ,KC_F5  ,                        KC_F6  ,KC_F7  ,KC_F8  ,KC_F9  ,KC_F10 ,KC_F11 , \
    _______,KC_1   ,KC_2   ,KC_3   ,KC_4   ,KC_5   ,                        KC_6   ,KC_7   ,KC_8   ,KC_9   ,KC_0   ,_______, \
    _______,KC_EXLM,KC_AT  ,KC_HASH,KC_DLR ,KC_PERC,                        KC_CIRC,KC_AMPR,KC_ASTR,KC_EQL ,KC_PLUS,_______, \
    _______,_______,_______,_______,_______,_______,                        _______,_______,_______,_______,_______,_______, \
                    _______,_______,                                                        _______,_______,                 \
                                    _______,_______,                        _______,_______,                                 \
                                            _______,_______,        _______,_______,                                         \
                                            _______,_______,        _______,_______                                          \
),

/**
 * Navigation
 * +-----------------------------------------------+                       +-----------------------------------------------+
 * |       |       |       |       |       |       |                       |       |       |       |       |       |       |
 * |-------+-------+-------+-------+-------+-------|                       |-------+-------+-------+-------+-------+-------|
 * |       |       |       |       |       |       |                       |       |page up|  up   |page_dn|       |       |
 * |-------+-------+-------+-------+-------+-------|                       |-------+-------+-------+-------+-------+-------|
 * |       |  gui  |  alt  | shift | ctrl  |       |                       | home  | left  | down  | right |  end  |       |
 * |-------+-------+-------+-------+-------+-------|                       |-------+-------+-------+-------+-------+-------|
 * |       |       |       |       |       |       |                       |       |       |       |       |       |       |
 * +---------------+-------+-------+---------------+                       +---------------+-------+-------+---------------+
 *                 |       |       |                                                       |       |       |
 *                 +---------------+---------------+                       +---------------+---------------+
 *                                 |       |       |                       |       |       |
 *                                 +---------------+                       +---------------+
 *                                         +---------------+       +---------------+
 *                                         |       |       |       |       |       |
 *                                         |-------+-------|       |-------+-------|
 *                                         | adjust| adjust|       |       |       |
 *                                         +---------------+       +---------------+
 */
[_NAV] = LAYOUT_5x6(
    _______,_______,_______,_______,_______,_______,                        _______,_______,_______,_______,_______,_______, \
    _______,_______,_______,_______,_______,_______,                        _______,KC_PGUP,KC_UP  ,KC_PGDN,_______,_______, \
    _______,KC_LGUI,KC_LALT,KC_LSFT,KC_LCTL,_______,                        KC_HOME,KC_LEFT,KC_DOWN,KC_RGHT,KC_END ,_______, \
    _______,_______,_______,_______,_______,_______,                        _______,_______,_______,_______,_______,_______, \
                    _______,_______,                                                        _______,_______,                 \
                                    _______,_______,                        _______,_______,                                 \
                                            _______,_______,        _______,_______,                                         \
                                            ADJUST ,ADJUST ,        _______,_______                                          \
),

[_MEDIA] = LAYOUT_5x6(
    _______,_______,_______,_______,_______,_______,                        _______,_______,_______,_______,_______,_______, \
    _______,_______,_______,_______,_______,_______,                        KC_VOLU,KC_MSEL,KC_MSTP,_______,_______,_______, \
    _______,_______,_______,_______,_______,_______,                        KC_MUTE,KC_MPRV,KC_MPLY,KC_MNXT,_______,_______, \
    _______,_______,_______,_______,_______,_______,                        KC_VOLD,_______,_______,_______,_______,_______, \
                    _______,_______,                                                        _______,_______,                 \
                                    _______,_______,                        _______,_______,                                 \
                                            _______,_______,        _______,_______,                                         \
                                            _______,_______,        _______,_______                                          \
),

[_ADJUST] = LAYOUT_5x6(
    _______,_______,_______,_______,_______,_______,                        _______,_______,_______,_______,_______,_______, \
    _______,_______,_______,_______,_______,_______,                        _______,_______,_______,_______,_______,_______, \
    _______,_______,_______,_______,_______,_______,                        _______,_______,_______,_______,_______,_______, \
    DEBUG  ,_______,_______,_______,_______,RESET  ,                        _______,_______,_______,_______,_______,_______, \
                    _______,_______,                                                        _______,_______,                 \
                                    _______,_______,                        _______,_______,                                 \
                                            _______,_______,        _______,_______,                                         \
                                            _______,_______,        _______,_______                                          \
),
};

bool process_record_user(uint16_t keycode, keyrecord_t *record) {
    mod_state = get_mods();

    switch (keycode) {
        case KC_BSPC:
        {
            static bool delkey_registered;
            if (record->event.pressed) {
                if (mod_state & MOD_MASK_SHIFT) {
                    // In case only one shift is held
                    // see https://stackoverflow.com/questions/1596668/logical-xor-operator-in-c
                    // This also means that in case of holding both shifts and pressing KC_BSPC,
                    // Shift+Delete is sent (useful in Firefox) since the shift modifiers aren't deleted.
                    if (!(mod_state & MOD_BIT(KC_LSHIFT)) != !(mod_state & MOD_BIT(KC_RSHIFT))) {
                        del_mods(MOD_MASK_SHIFT);
                    }
                    register_code(KC_DEL);
                    delkey_registered = true;
                    set_mods(mod_state);
                    return false;
                }
            } else {
                if (delkey_registered) {
                    unregister_code(KC_DEL);
                    delkey_registered = false;
                    return false;
                }
            }
            return true;
        }
    }

    return true;
}

uint16_t get_tapping_term(uint16_t keycode, keyrecord_t *record) {
    switch (keycode) {
        // My pinkys are not as fast
        case HOME_A:
        case HOME_O:
        case HOME_SC:
            return TAPPING_TERM + 50;

        case SYM_ENT: // Very low tapping term so I don't hit enter actidentlly
            return TAPPING_TERM - 20;

        // The One Shot Shift thumb key is used more frequently.
        // To avoid accidental shiftings of T or N or I
        // when rolling over the home row, the tapping term
        // is increased.
        case HOME_S:
        case HOME_E:
        case HOME_D:
        case HOME_K:
            return TAPPING_TERM + 10;

        default:
            return TAPPING_TERM;
    }
}

// ---------------------------------------------------------------------------------------------------------------------------

/**
 * Layer
 * +-----------------------------------------------+                       +-----------------------------------------------+
 * |       |       |       |       |       |       |                       |       |       |       |       |       |       |
 * |-------+-------+-------+-------+-------+-------|                       |-------+-------+-------+-------+-------+-------|
 * |       |       |       |       |       |       |                       |       |       |       |       |       |       |
 * |-------+-------+-------+-------+-------+-------|                       |-------+-------+-------+-------+-------+-------|
 * |       |       |       |       |       |       |                       |       |       |       |       |       |       |
 * |-------+-------+-------+-------+-------+-------|                       |-------+-------+-------+-------+-------+-------|
 * |       |       |       |       |       |       |                       |       |       |       |       |       |       |
 * +---------------+-------+-------+---------------+                       +---------------+-------+-------+---------------+
 *                 |       |       |                                                       |       |       |
 *                 +---------------+---------------+                       +---------------+---------------+
 *                                 |       |       |                       |       |       |
 *                                 +---------------+                       +---------------+
 *                                         +---------------+       +---------------+
 *                                         |       |       |       |       |       |
 *                                         |-------+-------|       |-------+-------|
 *                                         |       |       |       |       |       |
 *                                         +---------------+       +---------------+
 */
/*
[_layer] = LAYOUT_5x6(
    _______,_______,_______,_______,_______,_______,                        _______,_______,_______,_______,_______,_______, \
    _______,_______,_______,_______,_______,_______,                        _______,_______,_______,_______,_______,_______, \
    _______,_______,_______,_______,_______,_______,                        _______,_______,_______,_______,_______,_______, \
    _______,_______,_______,_______,_______,_______,                        _______,_______,_______,_______,_______,_______, \
                    _______,_______,                                                        _______,_______,                 \
                                    _______,_______,                        _______,_______,                                 \
                                            _______,_______,        _______,_______,                                         \
                                            _______,_______,        _______,_______                                          \
),
*/
